{
  "hash": "1432b37fb4de484c8360b29fd9785401",
  "result": {
    "markdown": "---\ntitle: \"Kartor över valdistrikt i R\"\nauthor: \"Filip Wästberg\"\ndate: \"2022-09-19\"\ncategories: [valet]\nimage: preview.png\n---\n\n\nDet har gått mer än en vecka sedan valet och resultatdata har nu börjat publiceras på valmyndigheten.se. I det här inlägget tänkte jag visa hur vi kan använda `swemaps2` för att analysera valresultatet på kommunal nivå.\n\nTill att börja med kan vi ladda ner valresutlatet som finns i en Excel på valmyndigheten.se\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\nlibrary(tidyverse)\n\ndownload.file(\"https://www.val.se/download/18.14c1f613181ed0043d567ae/1663009000443/valresultat-riksdagen-preliminar-jamforande-statistik.xlsx\",\n              destfile = \"data/valresultat-riksdagen-preliminar-jamforande-statistik.xlsx\")\n\nvalresultat <- read_excel(\"data/valresultat-riksdagen-preliminar-jamforande-statistik.xlsx\", sheet = 3) |> \n  janitor::clean_names() \n\nvalresultat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4,350 × 9\n   riksdagsvalkrets kommu…¹ parti roste…² andel…³  diff diff_a…⁴ roste…⁵ andel…⁶\n   <chr>            <chr>   <chr>   <dbl>   <dbl> <dbl>    <dbl>   <dbl>   <dbl>\n 1 Västra Götaland… Ale     Mode…    3451  0.182   -188 -0.00588    3639  0.188 \n 2 Västra Götaland… Ale     Cent…     994  0.0525  -364 -0.0177     1358  0.0703\n 3 Västra Götaland… Ale     Libe…     631  0.0333  -283 -0.0139      914  0.0473\n 4 Västra Götaland… Ale     Kris…    1065  0.0563  -147 -0.00642    1212  0.0627\n 5 Västra Götaland… Ale     Arbe…    5687  0.301    286  0.0211     5401  0.279 \n 6 Västra Götaland… Ale     Väns…    1259  0.0665  -219 -0.00993    1478  0.0765\n 7 Västra Götaland… Ale     Milj…     664  0.0351   -95 -0.00417     759  0.0393\n 8 Västra Götaland… Ale     Sver…    4864  0.257    563  0.0346     4301  0.223 \n 9 Västra Götaland… Ale     Övri…     307  0.0162    39  0.00236     268  0.0139\n10 Västra Götaland… Ale     Gilt…   18922  1       -408 NA         19330  1     \n# … with 4,340 more rows, and abbreviated variable names ¹​kommunnamn,\n#   ²​roster_2022, ³​andel_2022, ⁴​diff_andel, ⁵​roster_2018, ⁶​andel_2018\n```\n:::\n:::\n\n\nVi ser att det i kolumnen `parti` finns en del värden som inte är partier, ex. `Röstberättigande`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvalresultat |> \n  group_by(parti) |> \n  summarise(roster_2022 = sum(roster_2022)) |> \n  arrange(desc(roster_2022))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 15 × 2\n   parti                                  roster_2022\n   <chr>                                        <dbl>\n 1 Röstberättigade                            7772120\n 2 Valdeltagande vallokaler                   6320963\n 3 Giltiga Röster                             6227229\n 4 Arbetarepartiet-Socialdemokraterna         1897965\n 5 Sverigedemokraterna                        1282352\n 6 Moderaterna                                1187350\n 7 Centerpartiet                               417851\n 8 Vänsterpartiet                              414604\n 9 Kristdemokraterna                           333327\n10 Miljöpartiet de gröna                       314579\n11 Liberalerna (tidigare Folkpartiet)          286503\n12 Övriga anmälda partier                       92698\n13 Ogiltiga röster - blanka                     59218\n14 Ogiltiga röster - övriga                     31137\n15 Ogiltiga röster - inte anmälda partier        3379\n```\n:::\n:::\n\n\nVi är bara intresserade av de stora riksdagspartierna, så vi filtrerar bort värden som inte är partier.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(stringr)\nvalresultat_partier <- valresultat |> \n  filter(!(parti %in% c(\"Röstberättigade\",\n                        \"Valdeltagande vallokaler\",\n                        \"Giltiga Röster\")) &\n           !str_detect(parti, \"Ogiltiga\"))\n```\n:::\n\n\nFör att kunna redovisa resultatet på en karta behöver vi knyta det till ett geografiskt objekt. Det kan vi enkelt göra genom att joina vår data.frame med `municipality` som är ett dataset i `swemaps2`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(swemaps2)\nvalresultat_kommun <- swemaps2::municipality |> \n  left_join(\n    valresultat_partier, by = c(\"kn_namn\" = \"kommunnamn\")\n  )\n\nvalresultat_kommun\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 2602 features and 12 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 1230810 ymin: 6137234 xmax: 1880916 ymax: 7669583\nProjected CRS: RT90 2.5 gon V\n# A tibble: 2,602 × 13\n   kn_kod kn_namn ln_kod ln_namn                  geometry riksd…¹ parti roste…²\n   <chr>  <chr>   <chr>  <chr>          <MULTIPOLYGON [m]> <chr>   <chr>   <dbl>\n 1 0114   Upplan… 01     Stockh… (((1620218 6599562, 1618… Stockh… Mode…    5043\n 2 0114   Upplan… 01     Stockh… (((1620218 6599562, 1618… Stockh… Cent…    1461\n 3 0114   Upplan… 01     Stockh… (((1620218 6599562, 1618… Stockh… Libe…    1126\n 4 0114   Upplan… 01     Stockh… (((1620218 6599562, 1618… Stockh… Kris…    1194\n 5 0114   Upplan… 01     Stockh… (((1620218 6599562, 1618… Stockh… Arbe…    7389\n 6 0114   Upplan… 01     Stockh… (((1620218 6599562, 1618… Stockh… Väns…    1805\n 7 0114   Upplan… 01     Stockh… (((1620218 6599562, 1618… Stockh… Milj…     894\n 8 0114   Upplan… 01     Stockh… (((1620218 6599562, 1618… Stockh… Sver…    5205\n 9 0114   Upplan… 01     Stockh… (((1620218 6599562, 1618… Stockh… Övri…     450\n10 0115   Vallen… 01     Stockh… (((1637371 6601120, 1636… Stockh… Mode…    5272\n# … with 2,592 more rows, 5 more variables: andel_2022 <dbl>, diff <dbl>,\n#   diff_andel <dbl>, roster_2018 <dbl>, andel_2018 <dbl>, and abbreviated\n#   variable names ¹​riksdagsvalkrets, ²​roster_2022\n```\n:::\n:::\n\n\nJag är intresserad av hur det gått för Moderaterna i Skåne så jag filtrerar ut Skåne och moderaterna.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvalresultat_skane <- valresultat_kommun |> \n  filter(parti == \"Moderaterna\" & str_detect(tolower(ln_namn), \"skåne\"))\n```\n:::\n\n\nNu har vi valresultat knutet till geografiska objekt och kan visualisera det. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(scales)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'scales'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:purrr':\n\n    discard\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:readr':\n\n    col_factor\n```\n:::\n\n```{.r .cell-code}\nplot_skane <- valresultat_skane |> \n  ggplot(aes(fill = diff_andel)) +\n  geom_sf() +\n  scale_fill_viridis_c(option = \"magma\", label = scales::percent) +\n  theme_swemap2()\n\nplot_skane\n```\n\n::: {.cell-output-display}\n![](analysera-valet_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nFör att göra visualiseringen lite mer informativ kan vi skapa en dataframe där vi har de kommuner där Moderaterna tappat mest och där det ökat mest.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_skane <- valresultat_skane |> \n  slice_max(diff_andel, n = 3)\n\nbottom_skane <- valresultat_skane |> \n  slice_min(diff_andel, n = 3)\n\nlabels_skane <- bind_rows(top_skane, bottom_skane)\n```\n:::\n\n\nFör att skapa snygga labels använder jag `ggrepel`. Vi ser att Bromölla är den kommun där moderaterna gått framåt. Annars ser de ut att tappa i de flesta kommuner.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggrepel)\nplot_skane <- plot_skane +\n  geom_label_repel(\n    data = labels_skane,\n    aes(label = kn_namn, geometry = geometry),\n    stat = \"sf_coordinates\",\n    min.segment.length = 0,\n    color = \"black\",\n    fill = \"white\"\n  ) \n\nplot_skane\n```\n\n::: {.cell-output-display}\n![](analysera-valet_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nTill sist ändrar jag titel och lite andra parametrar för att få en mer tilltalande visualisering:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_skane +\n  labs(\n    title = \"Förändring andel röster för Moderaterna\",\n    subtitle = \"2018 till 2022\",\n    fill = \"Skillnad\",\n    caption = \"Källa: Valmyndigheten och SCB\"\n  )\n```\n\n::: {.cell-output-display}\n![](analysera-valet_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "analysera-valet_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}